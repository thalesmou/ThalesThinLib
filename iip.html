<!DOCTYPE html>
<html
  lang="en"
  style="
    width: 100%;
    height: 100%;
    padding: 0;
    margin: 0;
    box-sizing: border-box;
  "
>
  <head>
    <title>IIP v1.0</title>
    <link rel="shortcut icon" href="./images/favicon.png" />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta http-equiv="cache-control" content="max-age=0" />
    <meta http-equiv="cache-control" content="no-cache" />
    <meta http-equiv="expires" content="0" />
    <meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
    <meta http-equiv="pragma" content="no-cache" />
    <link rel="stylesheet" href="./css/bootstrap.min.css" />
    <link rel="stylesheet" href="./css/style.css" />
    <link rel="stylesheet" type="text/css" href="./css/animate.css" />
    <link rel="stylesheet" type="text/css" href="./css/select2.min.css" />
    <link rel="stylesheet" type="text/css" href="./css/perfect-scrollbar.css" />
    <link rel="stylesheet" type="text/css" href="./css/main.css" />
    <link href="./css/font-awesome.min.css" rel="stylesheet" />
  </head>
  <body id="background">
    <script>
      let origin = "https://thales.sites.test.thirdstream.ca"; //base origin
      let branchId = encodeURIComponent("thales"); //optional to select branch
      let thisOrigin = "*"; //For TESTING ONLY, this is NOT secure
      //const thisOrigin = encodeURIComponent(window.location.origin); //needed if multilpe allowed origins
      let url =
        origin +
        "/idvbranch/?targetOrigin=" +
        thisOrigin +
        "&" +
        (branchId ? "branchId=" + branchId : "");
      //add a signature, generated by backend. In this example presumably
      //added as a query parameter
      let signature = new URLSearchParams(window.location.search).get("iipSig");
      if (signature) {
        url += "#sig=" + signature;
      }

      //const origin = "https://cottoolbox";
      //const url = origin + "/#eyJVU0VSX1BST1hZIjoiY3NtdGVzdHBhZ2UwMTAiLCJQQVNTX1BST1hZIjoiMkJLWm9OSjI2M0I4RVNjbGFYb3pRSmozIiwiaWRfdXNlcm5hbWUiOiIiLCJpZF9wYXNzd29yZCI6IiIsImFjYXNfZW5kcG9pbnQiOiIiLCJET19WRVJJRklDQVRJT04iOnRydWUsIk1BWF9TREtfQVRURU1QVFMiOjMsIk1BWF9TRVJWRVJfQVRURU1QVFMiOjMsIkNBUFRVUkVfVElNRU9VVCI6NjAwMDAsIkFDVElPTl9CVVRUT04iOmZhbHNlLCJET19DVVNUT01TX0JVVFRPTiI6ZmFsc2UsIkpQRUdfUVVBTElUWSI6MC45LCJTSEFSUE5FU1NfVEhSRVNIIjo1MCwiR0xBUkVfVEhSRVNIIjo1MCwiRFBJX1RIUkVTSCI6NDAwLCJGQUxMQkFDS19QT0xJQ1kiOiIiLCJET19DVVNUT01TIjpmYWxzZSwiRE9fQ1VTVE9NU19GQUNFIjpmYWxzZSwiRE9fQkFSQ09ERSI6ZmFsc2UsIkRPX1NUSUxMX1BIT1RPIjpmYWxzZSwiUkVBREVSX0RFQkFSRUxMIjpmYWxzZSwiRE9fREVCVUciOmZhbHNlLCJET19SRUFERVIiOnRydWUsIkRPX1ZFUklGSUNBVElPTl9VVl9JUiI6ZmFsc2UsIkRPX1JFQURFUl9OT19UTFMiOmZhbHNlLCJNSU5fRFBJX1RIUkVTSCI6MzAwLCJTUEVDSUFMX0RPVUJMRV9WRVJJRiI6ZmFsc2UsIk9QVElNSVpFX01PQklMRV9SRVMiOmZhbHNlLCJDQVBUVVJFX01FVEhPRCI6Ik1vYmlsZSJ9";
      let win = null,
        v = null,
        fn = null,
        ln = null,
        doc = null,
        t = null,
        fw = null,
        fi = null,
        fu = null,
        bw = null,
        bi = null,
        bu = null;

      function closeTab() {
        if (win && !win.closed) win.close();
      }

      function addEvents() {
        window.removeEventListener("beforeunload", closeTab);
        window.addEventListener("beforeunload", closeTab);
      }

      function reset() {
        v = document.getElementById("verification");
        fn = document.getElementById("fname");
        ln = document.getElementById("lname");
        doc = document.getElementById("template");
        t = document.getElementById("verifNum");
        fw = document.getElementById("frontWhiteImage");
        fi = document.getElementById("frontIRImage");
        fu = document.getElementById("frontUVImage");
        bw = document.getElementById("backWhiteImage");
        bi = document.getElementById("backIRImage");
        bu = document.getElementById("backUVImage");
        v.value = "";
        v.style.background = "gray";
        fn.value = "";
        ln.value = "";
        doc.value = "";
        t.value = "";
        fw.src = "";
        fi.src = "";
        fu.src = "";
        bw.src = "";
        bi.src = "";
        bu.src = "";
      }

      function processMessage(e) {
        //MUST check the origin and not accept messages from non-authorized origins
        if (!e || e.origin !== origin) {
          console.error("Not allowed origin!");
          window.removeEventListener("message", processMessage);
          return;
        }
        try {
          const data = JSON.parse(e.data);
          const res = data.verification.decisionOutcome;
          v.value = res ? res : "IN PROGRESS";
          v.style.background =
            res === "APPROVED" ? "green" : res === "REJECTED" ? "red" : "blue";
          fn.value = data.verification.documentDetail.firstName
            ? data.verification.documentDetail.firstName
            : "";
          ln.value = data.verification.documentDetail.lastName
            ? data.verification.documentDetail.lastName
            : "";
          doc.value = data.verification.documentClassification.documentName
            ? data.verification.documentClassification.documentName
            : "";
          t.value = data.verification.verificationNumber
            ? data.verification.verificationNumber
            : "";
          fw.src = data.images.frontWhiteImage
            ? "data:image/jpeg;base64," + data.images.frontWhiteImage
            : "";
          fi.src = data.images.frontIRImage
            ? "data:image/jpeg;base64," + data.images.frontIRImage
            : "";
          fu.src = data.images.frontUVImage
            ? "data:image/jpeg;base64," + data.images.frontUVImage
            : "";
          bw.src = data.images.backWhiteImage
            ? "data:image/jpeg;base64," + data.images.backWhiteImage
            : "";
          bi.src = data.images.backIRImage
            ? "data:image/jpeg;base64," + data.images.backIRImage
            : "";
          bu.src = data.images.backUVImage
            ? "data:image/jpeg;base64," + data.images.backUVImage
            : "";
        } catch (e) {
          console.error("Parse error: " + e);
        } finally {
          //Remove event listener to only get one result
          window.removeEventListener("message", processMessage);
        }
      }

      function verifyIdentity() {
        addEvents();
        if (!win || win.closed) {
          closeTab();
          win = window.open(url);
        }
        reset();
        win.focus();
        window.removeEventListener("message", processMessage);
        window.addEventListener("message", processMessage);
      }
    </script>
    <button
      type="button"
      class="btn btn-primary btn-lg"
      style="margin-left: 5px"
      onclick="verifyIdentity()"
    >
      Verify Identity
    </button>

    <div class="col-md-12">
      <input
        id="verification"
        type="text"
        value=""
        placeholder=""
        style="width: 100%; background: gray; color: white"
        readonly
      />
    </div>
    <div class="col-md-12">
      <input
        id="fname"
        type="text"
        value=""
        placeholder="First Name"
        style="width: 100%"
      />
    </div>
    <div class="col-md-12">
      <input
        id="lname"
        type="text"
        value=""
        placeholder="Last Name"
        style="width: 100%"
      />
    </div>
    <div class="col-md-12">
      <input
        id="template"
        type="text"
        value=""
        placeholder="Document Type"
        style="width: 100%"
      />
    </div>
    <div class="col-md-12">
      <input
        id="verifNum"
        type="text"
        value=""
        placeholder="Tracking Number"
        style="width: 100%"
      />
    </div>
    <div class="col-md-12">
      <img
        id="frontWhiteImage"
        alt="No Image"
        style="
          width: 100%;
          height: 100%;
          object-fit: contain;
          max-height: 100px;
        "
      />
    </div>
    <div class="col-md-12">
      <img
        id="frontIRImage"
        alt="No Image"
        style="
          width: 100%;
          height: 100%;
          object-fit: contain;
          max-height: 100px;
        "
      />
    </div>
    <div class="col-md-12">
      <img
        id="frontUVImage"
        alt="No Image"
        style="
          width: 100%;
          height: 100%;
          object-fit: contain;
          max-height: 100px;
        "
      />
    </div>
    <div class="col-md-12">
      <img
        id="backWhiteImage"
        alt="No Image"
        style="
          width: 100%;
          height: 100%;
          object-fit: contain;
          max-height: 100px;
        "
      />
    </div>
    <div class="col-md-12">
      <img
        id="backIRImage"
        alt="No Image"
        style="
          width: 100%;
          height: 100%;
          object-fit: contain;
          max-height: 100px;
        "
      />
    </div>
    <div class="col-md-12">
      <img
        id="backUVImage"
        alt="No Image"
        style="
          width: 100%;
          height: 100%;
          object-fit: contain;
          max-height: 100px;
        "
      />
    </div>
  </body>
</html>
