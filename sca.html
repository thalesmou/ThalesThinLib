<!DOCTYPE html>
<html lang="en">
  <head>
    <title>WebSCA v1.5</title>
    <link rel="shortcut icon" href="./images/favicon.png" />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta http-equiv="cache-control" content="max-age=0" />
    <meta http-equiv="cache-control" content="no-cache" />
    <meta http-equiv="expires" content="0" />
    <meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
    <meta http-equiv="pragma" content="no-cache" />
    <link rel="stylesheet" href="./css/bootstrap.min.css" />
    <link rel="stylesheet" href="./css/style2.css" />
    <link rel="stylesheet" type="text/css" href="./css/animate.css" />
    <link rel="stylesheet" type="text/css" href="./css/select2.min.css" />
    <link
      rel="stfylesheet"
      type="text/css"
      href="./css/perfect-scrollbar.css"
    />
    <link rel="stylesheet" type="text/css" href="./css/main.css" />
    <link href="./css/font-awesome.min.css" rel="stylesheet" />
  </head>
  <body id="background">
    <div class="container center">
      <div>
        <div class="col-md-12">
          <h2 id="mainheader" class="white"></h2>
          <p id="maintext" class="white"></p>
        </div>
      </div>
      <div id="actionbox">
        <div class="col-md-6 col-md-offset-3 center">
          <div class="btn-container">
            <h1 id="OKBox" class="imgupload ok">
              <i class="fa fa-check-circle"></i>
            </h1>
            <h1 id="NOKBox" class="imgupload stop">
              <i class="fa fa-times-circle"></i>
            </h1>
            <h1 id="waitBox" class="imgupload wait">
              <i class="fa fa-hourglass-half"></i>
            </h1>
          </div>
        </div>
      </div>
      <div class="col-md-12" style="margin-top: 10px">
        <button
          type="button"
          id="mainbtn"
          class="btn btn-primary btn-lg"
          style="margin-left: 10px"
        ></button>
        <button
          type="button"
          id="secbtn"
          class="btn btn-primary btn-lg"
          style="margin-left: 10px"
        ></button>
      </div>
      <div id="registerLink" class="col-md-12" style="margin: 10px">
        <a class="white" href="#" onclick="start(true);">Not Registered?</a>
      </div>
      <div id="enrollOpts" class="col-md-12">
        <div style="margin-top: 10px">
          <p class="white">User</p>
        </div>
        <div class="col-md-12">
          <input
            id="username"
            value=""
            placeholder="Username (user.name)"
            style="width: 100%"
            required
          />
        </div>
        <div class="col-md-12">
          <input
            id="displayName"
            value=""
            placeholder="Display Name (user.displayName)"
            style="width: 100%"
          />
        </div>
        <div class="col-md-12">
          <input
            id="userId"
            value=""
            placeholder="User ID/Handle (user.id)"
            style="width: 100%"
          />
        </div>
        <div style="margin-top: 10px">
          <p class="white">Relying Party (Service Provider)</p>
        </div>
        <div class="col-md-12">
          <input
            id="challenge"
            value=""
            placeholder="Server Challenge (challenge)"
            style="width: 100%"
            required
          />
        </div>
        <div class="col-md-12">
          <input
            id="serviceName"
            value=""
            placeholder="Relying Party Name (rp.name)"
            style="width: 100%"
            required
          />
        </div>
        <div class="col-md-12">
          <input
            id="serviceId"
            value=""
            placeholder="Relying Party ID (rp.id)"
            style="width: 100%"
          />
        </div>
        <div class="col-md-12">
          <input
            id="timeout"
            value=""
            placeholder="Timeout (timeout)"
            style="width: 100%"
          />
        </div>
        <div style="margin-top: 10px">
          <p class="white">Passkey Selection Options</p>
        </div>
        <div class="col-md-12">
          <input
            id="excludeCredentialList"
            value=""
            placeholder="Exclude Existing Credential IDs [comma seperated] (excludeCredentials)"
            style="width: 100%"
          />
        </div>
        <div class="col-md-12">
          <select id="authenticatorSelection" style="width: 100%">
            <option value="">Any Platform Allowed</option>
            <option value="cross-platform">Must be Cross-Platform</option>
            <option value="platform">Must be Platform-Only</option>
          </select>
        </div>
        <div class="col-md-12">
          <select id="attestation" style="width: 100%">
            <option value="none">No Attestation</option>
            <option value="direct">Direct Attestation</option>
          </select>
        </div>
        <div class="col-md-12">
          <select id="residentKey" style="width: 100%">
            <option value="required">Discoverable Credentials Required</option>
            <option value="preferred">
              Discoverable Credentials Preferred
            </option>
            <option value="discouraged">
              Discoverable Credentials Discouraged
            </option>
          </select>
        </div>
        <div class="col-md-12">
          <select id="userVerification" style="width: 100%">
            <option value="required">User Verification Required</option>
            <option value="preferred">User Verification Preferred</option>
            <option value="discouraged">User Verification Discouraged</option>
          </select>
        </div>
        <div style="margin-top: 10px">
          <p class="white">Extensions</p>
        </div>
        <div class="col-md-12">
          <input
            id="credentialName"
            value=""
            placeholder="Friendly Name (Thales Extension)"
            style="width: 100%"
          />
        </div>
      </div>
      <div class="col-md-12">
        <div class="col-md-12">
          <select
            id="usernameAuthMode"
            style="width: 100%"
            onchange="showUsername()"
          >
            <option value="false">With Username</option>
            <option value="">Without Username</option>
            <option value="true">Conditional</option>
            >
          </select>
          <input
            id="usernameAuth"
            type="text"
            value=""
            placeholder="Username"
            style="width: 100%"
            autocomplete="username webauthn"
            required
          />
        </div>
      </div>
      <div id="authOpts" class="col-md-12">
        <div style="margin-top: 10px">
          <p class="white">Relying Party (Service Provider)</p>
        </div>
        <div class="col-md-12">
          <input
            id="challengeAuth"
            value=""
            placeholder="Server Challenge (challenge)"
            style="width: 100%"
          />
        </div>
        <div class="col-md-12">
          <input
            id="serviceIdAuth"
            value=""
            placeholder="Relying Party ID (rp.id)"
            style="width: 100%"
          />
        </div>
        <div class="col-md-12">
          <input
            id="timeoutAuth"
            value=""
            placeholder="Timeout (timeout)"
            style="width: 100%"
          />
        </div>
        <div style="margin-top: 10px">
          <p class="white">Passkey Selection Options</p>
        </div>
        <div class="col-md-12">
          <input
            id="credentialList"
            value=""
            placeholder="Allowed Credential IDs [comma seperated] (allowCredentials.id)"
            style="width: 100%"
          />
        </div>
        <div class="col-md-12">
          <select id="credentialTransports" style="width: 100%">
            <option value="">Any Device</option>
            <option value="internal">This Device Only</option>
            <option value="hybrid">Smartphone/Tablet Only</option>
            <option value="usb,nfc,ble">Security Key (USB, BLE, NFC)</option>
            <option value="hybrid,internal">
              Smartphone/Tablet Or This Device
            </option>
            <option value="internal, usb, nfc, ble">
              Security Key Or This Device
            </option>
          </select>
        </div>
        <div class="col-md-12">
          <select id="userVerificationAuth" style="width: 100%">
            <option value="required">User Verification Required</option>
            <option value="preferred">User Verification Preferred</option>
            <option value="discouraged">User Verification Discouraged</option>
          </select>
        </div>
      </div>
      <div class="col-md-12" style="margin-top: 10px"></div>
    </div>
    <div class="limiter" id="maintable">
      <div class="container-table100">
        <div class="wrap-table100" id="restable"></div>
      </div>
    </div>
    <script src="./cbor-js.js"></script>
    <script src="./websca.js"></script>
    <script>
      ThalesAuth.setDebug(true);

      //Prepouplate inputs fields from URL
      let doAuth = null;
      let doEnroll = null;
      new URL(window.location.href).searchParams.forEach((x, y) => {
        const el = document.getElementById(y);
        if (el && x) {
          el.value = x;
        }
        if (y === "doAuth") {
          doAuth = true;
        }
        if (y === "doEnroll") {
          doEnroll = true;
        }
      });

      function updateText(text, header) {
        document.getElementById("maintext").innerHTML = text;
        if (header) {
          document.getElementById("mainheader").innerHTML = header;
        }
      }

      function showWait(isEnrol) {
        document.getElementById("actionbox").style.display = "none";
        document.getElementById("mainbtn").style.display = "none";
        document.getElementById("waitBox").style.display = "block";
        document.getElementById("secbtn").style.display = "none";
        document.getElementById("NOKBox").style.display = "none";
        document.getElementById("OKBox").style.display = "none";
        document.getElementById("registerLink").style.display = "none";
        document.getElementById("enrollOpts").style.display = "none";
        document.getElementById("authOpts").style.display = "none";
        if (isEnrol) {
          document.getElementById("usernameAuth").style.display = "none";
        } else {
          document.getElementById("usernameAuth").style.display =
            "inline-block";
        }
      }

      function showOK() {
        document.getElementById("actionbox").style.display = "block";
        document.getElementById("waitBox").style.display = "none";
        document.getElementById("secbtn").style.display = "none";
        document.getElementById("NOKBox").style.display = "none";
        document.getElementById("registerLink").style.display = "none";
        document.getElementById("enrollOpts").style.display = "none";
        document.getElementById("authOpts").style.display = "none";
        document.getElementById("OKBox").style.display = "block";
        document.getElementById("usernameAuth").style.display = "none";

        const btn = document.getElementById("mainbtn");
        btn.style.display = "inline-block";
        btn.innerHTML = "Done";
        btn.onclick = () => {
          start();
        };
      }

      function showNOK() {
        document.getElementById("actionbox").style.display = "block";
        document.getElementById("waitBox").style.display = "none";
        document.getElementById("OKBox").style.display = "none";
        document.getElementById("secbtn").style.display = "none";
        document.getElementById("registerLink").style.display = "none";
        document.getElementById("enrollOpts").style.display = "none";
        document.getElementById("authOpts").style.display = "none";
        document.getElementById("NOKBox").style.display = "block";
        document.getElementById("usernameAuth").style.display = "none";
        document.getElementById("usernameAuthMode").style.display = "none";

        const btn = document.getElementById("mainbtn");
        btn.style.display = "inline-block";
        btn.innerHTML = "Done";
        btn.onclick = () => {
          start();
        };
      }

      function start(isEnrol, execute) {
        const btnEnroll = document.getElementById("mainbtn");
        const btnAuth = document.getElementById("secbtn");
        const username = document.getElementById("username");
        const userId = document.getElementById("userId");
        const displayName = document.getElementById("displayName");
        const serviceName = document.getElementById("serviceName");
        const serviceId = document.getElementById("serviceId");
        const credentialName = document.getElementById("credentialName");
        const attestation = document.getElementById("attestation");
        const residentKey = document.getElementById("residentKey");
        const userVerification = document.getElementById("userVerification");
        const challenge = document.getElementById("challenge");
        const timeout = document.getElementById("timeout");
        const excludeCredentialList = document.getElementById(
          "excludeCredentialList"
        );
        const authenticatorSelection = document.getElementById(
          "authenticatorSelection"
        );
        const challengeAuth = document.getElementById("challengeAuth");
        const usernameAuth = document.getElementById("usernameAuth");
        const usernameAuthMode = document.getElementById("usernameAuthMode");
        const credentialList = document.getElementById("credentialList");
        const timeoutAuth = document.getElementById("timeoutAuth");
        const serviceIdAuth = document.getElementById("serviceIdAuth");
        const credentialTransports = document.getElementById(
          "credentialTransports"
        );
        const userVerificationAuth = document.getElementById(
          "userVerificationAuth"
        );
        const resEl = document.getElementById("maintable");

        document.getElementById("OKBox").style.display = "none";
        document.getElementById("NOKBox").style.display = "none";
        document.getElementById("waitBox").style.display = "block";
        document.getElementById("actionbox").style.display = "block";
        document.getElementById("registerLink").style.display = "inline-block";
        document.getElementById("enrollOpts").style.display = "inline-block";
        document.getElementById("authOpts").style.display = "none";
        resEl.style.display = "none";

        usernameAuthMode.style.display = "inline-block";
        showUsername();

        btnEnroll.innerHTML = "Enroll";
        const enrollAction = () => {
          showWait(true);
          let enrollOpts = {
            username: username.value,
            userId: userId.value,
            displayName: displayName.value,
            serviceName: serviceName.value,
            serviceId: serviceId.value,
            credentialName: credentialName.value,
            attestation: attestation.value,
            challenge: challenge.value,
            timeout: timeout.value,
            authenticatorSelection: authenticatorSelection.value,
            residentKey: residentKey.value,
            userVerification: userVerification.value,
            excludeCredentialList: excludeCredentialList.value,
          };
          ThalesAuth.enroll(enrollOpts)
            .then(([response, id]) => {
              updateText(
                "It's a Passkey! Your new credentials are born.",
                "Enrolled"
              );
              showOK();
              resEl.style.display = "block";
              let tables = [
                {
                  header: [
                    "POST .../attestation/result?username=" + encodeURIComponent(username.value),
                  ],
                  rows: [
                    {
                      cols: ["Credential ID", id],
                    },
                    {
                      cols: [
                        "IDC Request Body",
                        JSON.stringify(response, null, 2),
                      ],
                    },
                  ],
                },
              ];
              makeTable(tables, resEl);
            })
            .catch((err) => {
              console.error("ENROLLMENT EXCEPTION: " + err);
              updateText(err);
              showNOK();
            });
        };
        btnEnroll.onclick = enrollAction;
        btnAuth.innerHTML = "Authenticate";
        const authAction = () => {
          showWait(false);
          const isConditional = usernameAuthMode.value === "true";
          const usernameLess = usernameAuthMode.value === "";          
          let authOpts = {
            challenge: challengeAuth.value,
            credentialList: credentialList.value,
            credentialTransports: credentialTransports.value,
            timeout: timeoutAuth.value,
            serviceId: serviceId.value,
            userVerificationAuth: userVerificationAuth.value,
            serviceIdAuth: serviceIdAuth.value,
            isConditional: isConditional,
          };
          usernameAuthMode.style.display = "none";
          ThalesAuth.auth(authOpts)
            .then((response) => {
              updateText("Nice! We knew it was you.", "Verified");
              showOK();
              resEl.style.display = "block";              
              let tables = [
                {
                  header: [
                    "POST .../assertion/result" + (isConditional || usernameLess ? "" : "?username=" +
                      encodeURIComponent(usernameAuth.value)),
                  ],
                  rows: [
                    {
                      cols: ["Body", JSON.stringify(response, null, 2)],
                    },
                  ],
                },
              ];
              makeTable(tables, resEl);
            })
            .catch((err) => {
              console.error("AUTHENTICATION EXCEPTION: " + err);
              updateText(err, "Failed Authentication");
              showNOK();
            });
        };
        btnAuth.onclick = authAction;

        if (isEnrol) {
          btnAuth.style.display = "none";
          btnEnroll.style.display = "inline-block";
          document.getElementById("enrollOpts").style.display = "inline-block";
          document.getElementById("authOpts").style.display = "none";
          usernameAuth.style.display = "none";
          usernameAuthMode.style.display = "none";
          updateText("Let's get to know you!", "Enroll");
          if (execute) enrollAction();
        } else {
          btnEnroll.style.display = "none";
          btnAuth.style.display = "inline-block";
          document.getElementById("enrollOpts").style.display = "none";
          document.getElementById("authOpts").style.display = "inline-block";
          showUsername();
          //In Conditional UI flow, the user has to enter Username
          updateText("Is this really you?", "Authenticate");
          if (execute) authAction();
        }
      }

      function makeTable(tables, attachTo) {
        while (attachTo.firstChild) {
          attachTo.removeChild(attachTo.firstChild);
        }
        for (let i = 0; i < tables.length; ++i) {
          let tableEl = document.createElement("div");
          tableEl.classList.add("table");
          attachTo.append(tableEl);
          let rowHeadEl = document.createElement("div");
          rowHeadEl.classList.add("row");
          rowHeadEl.classList.add("header");
          tableEl.append(rowHeadEl);
          let tableHeader = tables[i].header;
          for (let j = 0; j < tableHeader.length; ++j) {
            let headerEl = document.createElement("div");
            headerEl.classList.add("cell");
            headerEl.innerHTML = tableHeader[j];
            rowHeadEl.append(headerEl);
          }
          let rows = tables[i].rows;
          for (let j = 0; j < rows.length; ++j) {
            let rowEl = document.createElement("div");
            rowEl.classList.add("row");
            tableEl.append(rowEl);
            var cols = rows[j].cols;
            for (let k = 0; k < cols.length; ++k) {
              let colEl = document.createElement("div");
              colEl.classList.add("cell");
              if (typeof cols[k] === "object") {
                colEl.innerHTML = cols[k].outerHTML;
              } else {
                colEl.innerHTML = cols[k];
              }
              rowEl.append(colEl);
            }
          }
        }
      }

      function showUsername() {
        const hideUsername =
          document.getElementById("usernameAuthMode").value !== "false";
        document.getElementById("usernameAuth").style.display = hideUsername
          ? "none"
          : "inline-block";
      }

      //Start the flow, may execute right away without user action
      start(!!doEnroll, doEnroll === true || doAuth === true);
    </script>
  </body>
</html>
