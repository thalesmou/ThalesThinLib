import{__classPrivateFieldGet as e,__classPrivateFieldSet as t}from"tslib";import r from"@gbgplc/stickman-wasm";const i=e=>{const t=document.createElement("canvas");let r=1080,i=720;const{width:s,height:o}=e,a=t.getContext("2d");if((s>o?o:s)>i)if(s<o){r=i,i=r*(o/s)}else{r=i*(s/o)}else r=e.width,i=e.height;t.width=r,t.height=i,null==a||a.drawImage(e,0,0,r,i);const n=t.toDataURL("image/jpeg",.8);return null==a||a.clearRect(0,0,r,i),n},s=e=>new Promise((t=>{const r=document.createElement("img");r.onload=()=>{const e=i(r);URL.revokeObjectURL(r.src),t(e)},r.src=URL.createObjectURL(e)})),o=e=>new Promise((t=>{const r=document.createElement("img");r.onload=()=>{const e=i(r);t(e.split("base64,")[1])},r.src=e}));var a,n;!function(e){e[e.ID1=0]="ID1",e[e.ID2=1]="ID2",e[e.ID3=2]="ID3",e[e.OTHER=3]="OTHER",e[e.NONE=4]="NONE"}(a||(a={})),function(e){e[e.SMALL_DOCUMENT=0]="SMALL_DOCUMENT",e[e.OUT_OF_FRAME_DOCUMENT=1]="OUT_OF_FRAME_DOCUMENT",e[e.GOOD_DOCUMENT=2]="GOOD_DOCUMENT"}(n||(n={}));class h{constructor(){this.createWorker=e=>new Promise(((t,r)=>(this.smartCaptureWorker||(this.smartCaptureWorker=this.createCrossDomainWorker(e)),this.makeRequest("Initialise",null).then(t).catch(r)))),this.checkImage=e=>this.makeRequest("PerformQualityCheck",{image:e}),this.makeRequest=(e,t,r=(new Date).getTime().toString())=>new Promise(((i,s)=>{if(this.smartCaptureWorker){const o=({data:e})=>e.id===r?(this.smartCaptureWorker.removeEventListener("message",o),this.smartCaptureWorker.removeEventListener("error",a),"Error"===e.message?s():i(e.data)):s(),a=e=>(this.smartCaptureWorker.removeEventListener("message",o),this.smartCaptureWorker.removeEventListener("error",a),s(e));this.smartCaptureWorker.addEventListener("message",o),this.smartCaptureWorker.addEventListener("error",a),this.smartCaptureWorker.postMessage({id:r,message:e,data:t})}else s()}))}createCrossDomainWorker(e){let t;try{this.testSameOrigin(e)?(t=new Worker(e,{type:"module"}),t.onerror=r=>{r.preventDefault(),t=this.createWorkerFallback(e)}):t=this.createWorkerFallback(e)}catch(r){t=this.createWorkerFallback(e)}return t}createWorkerFallback(e){try{let t;try{t=new Blob([`importScripts('${e}');`],{type:"module"})}catch(r){const i=new(window&&window.BlobBuilder||window&&window.WebKitBlobBuilder||window&&window.MozBlobBuilder);i.append(`importScripts('${e}');`),t=i.getBlob("module")}const r=(window&&window.URL||window&&window.webkitURL).createObjectURL(t);return new Worker(r)}catch(e){console.log("WorkerFallback",e)}}testSameOrigin(e){const t=window.location,r=document.createElement("a");return r.href=e,r.hostname===t.hostname&&r.port===t.port&&r.protocol===t.protocol}}var c,d,l=new h;class m{constructor(){this._initialized=!1,this._initializing=!1,this.barcodeReaderId="barcode-reader",this.hiddenCanvas=document.createElement("canvas"),this.init=async()=>{if(this._initialized)return!0;if(this._initializing)return!1;{this._initializing=!0;const e=new URL("../smart-capture/SmartCaptureWorker.js",import.meta.url).href;try{return await l.createWorker(e),this._initializing=!1,this._initialized=!0,!0}catch(e){throw this._initializing=!1,this._initialized=!1,new Error("Create Worker Failed")}}},this.addBarcodeReaderDiv=e=>{if(document.getElementById(e))return;const t=document.createElement("div");t.id=e,t.style.display="none",document.body.appendChild(t)},this.processEncodedFrame=async e=>{const t=await l.checkImage(e);if(t&&t.quality&&t.coords){const e=t.quality.coordinateCheck?this.mapCorners(t.coords):void 0,r={width:t.coords.width,height:t.coords.height};return{isGood:t.isGood,dimensions:r,isAdequateDpi:t.quality.resolutionCheck,corners:e,isSharp:t.quality.blurCheck,isGlareFree:t.quality.glareCheck,failedChecks:t.failedChecks}}throw new Error("Part of result was null")},this.imageDataToBlob=async e=>{const t=e.width,r=e.height,{hiddenCanvas:i}=this,s=this.hiddenCanvas.getContext("2d");if(!s)throw new Error("Hidden Context Missing");i.width=t,i.height=r,s.putImageData(e,0,0);const o=await new Promise((e=>i.toBlob(e)));if(o)return o;throw new Error("Canvas To Blob Errored")},this.detect=async e=>{if(e.imageData){const t=await this.imageDataToBlob(e.imageData),r=await t.arrayBuffer(),i=await this.processEncodedFrame(r);if(i.isGood){const e=await this.crop(r,i);return i.image=e,i}return i}throw new Error("Image Data Was Null")},this.crop=async(e,t)=>{var r,i;if(!e||!t.corners)throw new Error("Image or Corners Missing");const{hiddenCanvas:s}=this,o=this.hiddenCanvas.getContext("2d");if(!o)throw new Error("Hidden Context Missing");if((null===(r=t.dimensions)||void 0===r?void 0:r.width)&&(null===(i=t.dimensions)||void 0===i?void 0:i.height)){const r=new Blob([e],{type:"image/jpeg"}),i=new Image;return(e=>new Promise(((r,a)=>{i.onload=function(){if(t.corners){const e=Math.min(t.corners.topLeft.y,t.corners.topRight.y),a=Math.max(t.corners.bottomLeft.y,t.corners.bottomRight.y),n=Math.min(t.corners.topLeft.x,t.corners.bottomLeft.x),h=Math.max(t.corners.topRight.x,t.corners.bottomRight.x);s.height=a-e,s.width=h-n,o.drawImage(i,n,e,h-n,a-e,0,0,s.width,s.height);const c=o.getImageData(0,0,s.width,s.height);o.clearRect(0,0,s.width,s.height),s.height=1,s.width=1,r(c)}},i.onerror=a,i.src=e})))(URL.createObjectURL(r))}throw new Error("Width or Height Missing")},this.addBarcodeReaderDiv(this.barcodeReaderId)}get isInitialized(){return this._initialized}get isInitializing(){return this._initializing}mapCorners(e){return{topLeft:{x:e.x,y:e.y},topRight:{x:e.x+e.width,y:e.y},bottomRight:{x:e.x+e.width,y:e.y+e.height},bottomLeft:{x:e.x,y:e.y+e.height}}}}c=m,d={value:void 0},m.getInstance=()=>(e(c,c,"f",d)||t(c,c,new c,"f",d),e(c,c,"f",d));class u{constructor(e){this.postMessage=(e,t,r)=>new Promise((i=>i(this.workerGlobalContext.postMessage({id:e,message:t,data:r})))),this.onError=e=>this.postMessage("","Error",{...e}),this.onMessage=({data:e})=>{switch(e.message){case"PerformQualityCheck":return this.onPerformQualityCheck(e.id,e.data);case"Terminate":return this.postMessage(e.id,"Terminate").then((()=>this.workerGlobalContext.close()));case"Initialise":return this.onInitialize().then((()=>this.postMessage(e.id,"ReadyToProcess"))).catch((()=>this.postMessage(e.id,"Error")))}},this.onInitialize=()=>new Promise((e=>this.smartCapture?e(this.smartCapture):r().then((t=>(this.smartCapture=t,e(t)))))),this.onPerformQualityCheck=(e,{image:t})=>{this.checkQuality(t).then((t=>this.postMessage(e,"CheckComplete",t))).catch((t=>this.postMessage(e,"CheckFailed",t.message)))},this.resolveCheck=(e,t,r)=>{const i=t.includes(e),s=r.includes(e);return i||s?i:null},this.checkQuality=e=>{const t=this.smartCapture.analyse_encoded_image(e),{document_bounds:r,failed_checks:i,is_good:s,successful_checks:o}=JSON.parse(t);return Promise.resolve({isGood:s,quality:{blurCheck:this.resolveCheck("BlurCheck",o,i),glareCheck:this.resolveCheck("GlareCheck",o,i),resolutionCheck:this.resolveCheck("LowResolutionCheck",o,i),coordinateCheck:this.resolveCheck("FullDocumentInViewCheck",o,i)},failedChecks:i,coords:r})},this.workerGlobalContext=e,this.workerGlobalContext.addEventListener("message",this.onMessage),this.workerGlobalContext.addEventListener("error",this.onError)}}new u(self);export{n as DocumentState,a as DocumentType,h as SmartCaptureHost,m as SmartCaptureModule,u as SmartCaptureWorker,s as resizeImageFromBlob,o as resizeImageFromString};
//# sourceMappingURL=index.js.map
